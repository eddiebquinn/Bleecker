---
- name: Include Komodo assertions
  ansible.builtin.include_tasks: assert.yml

- name: Install git (Debian)
  ansible.builtin.apt:
    name: git
    state: present
    update_cache: true
  when: ansible_facts.os_family == "Debian"

- name: Ensure Komodo repo base directory exists
  ansible.builtin.file:
    path: "{{ komodo_repo_dest | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure Komodo SSH directory exists
  ansible.builtin.file:
    path: "{{ komodo_repo_ssh_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Write Komodo repo deploy key (from CI)
  ansible.builtin.copy:
    dest: "{{ komodo_repo_ssh_key_path }}"
    content: "{{ komodo_repo_deploy_key_private }}"
    owner: root
    group: root
    mode: "0600"
  no_log: true

- name: Write pinned known_hosts for Komodo git server
  ansible.builtin.copy:
    dest: "{{ komodo_repo_known_hosts_path }}"
    content: "{{ komodo_git_known_hosts }}"
    owner: root
    group: root
    mode: "0644"

- name: Clone/update Komodo repo (using pinned host key + deploy key)
  ansible.builtin.git:
    repo: "{{ komodo_repo_url }}"
    dest: "{{ komodo_repo_dest }}"
    version: "{{ komodo_repo_branch }}"
    update: true
    force: true
    key_file: "{{ komodo_repo_ssh_key_path }}"
    accept_hostkey: false
  environment:
    GIT_SSH_COMMAND: >-
      ssh
      -o UserKnownHostsFile={{ komodo_repo_known_hosts_path }}
      -o StrictHostKeyChecking=yes
