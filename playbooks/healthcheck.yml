---
###############################################################################
# PLAY 1 — Base system hardening + MOTD + SSH config
###############################################################################
- name: Basic health checks
  hosts: all:!core_infra:!provisioning
  become: true
  become_method: sudo
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:

    ###########################################################################
    # User Setup
    ###########################################################################
    - name: Create eddie user with password
      ansible.builtin.user:
        name: eddie
        groups: sudo
        state: present
        shell: /bin/bash
        password: "{{ lookup('env', 'EDDIE_PASSWORD') | password_hash('sha512') }}"

    - name: Create .ssh directory for eddie
      ansible.builtin.file:
        path: /home/eddie/.ssh
        state: directory
        owner: eddie
        group: eddie
        mode: '0700'

    - name: Add GPG SSH keys to eddie
      ansible.posix.authorized_key:
        user: eddie
        state: present
        key: |
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINt1KNkGPH+YPWl6qHX0PhbsevkEw8H1R86nOVV03k8Z
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIF+zfnhEIwiI2u03QnRjghuAYFQRbdzqT1pXHWD69eaG

    ###########################################################################
    # SSH Hardening
    ###########################################################################
    - name: Disable root login and password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
        backrefs: yes
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^\s*PrintLastLog\s+', line: 'PrintLastLog no' }
      notify: Restart SSH

    ###########################################################################
    # Debian/Ubuntu-specific Tasks
    ###########################################################################
    - name: Stop apt-daily timers
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: false
        state: stopped
        daemon_reload: true
      loop:
        - apt-daily.timer
        - apt-daily-upgrade.timer
      when: ansible_facts.os_family == "Debian"

    - name: Mask apt-daily services
      ansible.builtin.systemd:
        name: "{{ item }}"
        masked: true
        enabled: false
        state: stopped
      loop:
        - apt-daily.service
        - apt-daily-upgrade.service
      when: ansible_facts.os_family == "Debian"

    - name: Ensure lsb-release is installed
      ansible.builtin.apt:
        name: lsb-release
        state: present
        update_cache: yes
      when: ansible_facts.os_family == "Debian"

    ###########################################################################
    # Custom MOTD
    ###########################################################################
    - name: Ensure update-motd directory exists
      ansible.builtin.file:
        path: /etc/update-motd.d
        state: directory
        owner: root
        group: root
        mode: '0755'
      when: ansible_facts.os_family == "Debian"

    - name: Deploy custom dynamic MOTD
      ansible.builtin.copy:
        dest: /etc/update-motd.d/50-custom
        owner: root
        group: root
        mode: '0755'
        content: |
          #!/bin/bash
          set -euo pipefail

          HOSTNAME=$(hostname)
          DISTRO=$(lsb_release -ds 2>/dev/null || head -n 1 /etc/*release 2>/dev/null)

          LAST_LINE=$(last -n 5 -w -R | grep -v -E '^(reboot|shutdown|wtmp begins)' | head -n 1 || true)
          LAST_USER=$(echo "$LAST_LINE" | awk '{print $1}')
          LAST_FROM=$(echo "$LAST_LINE" | awk '{print $3}')

          if command -v apt >/dev/null 2>&1; then
              PACKAGE_COUNT=$(dpkg -l 2>/dev/null | wc -l)
              PENDING_UPDATES=$(apt list --upgradable 2>/dev/null | grep -v '^Listing' | wc -l)
          else
              PACKAGE_COUNT="N/A"
              PENDING_UPDATES="N/A"
          fi

          if command -v systemctl >/dev/null 2>&1; then
              FAILED_SERVICES=$(systemctl --failed --no-legend 2>/dev/null | wc -l)
          else
              FAILED_SERVICES="N/A"
          fi

          cat <<EOF

          ---------------------------------------------------------------
          Host: ${HOSTNAME}
          Distro: ${DISTRO}
          Last Login: ${LAST_USER:-N/A} from ${LAST_FROM:-N/A}

          APT Health: ${PENDING_UPDATES} / ${PACKAGE_COUNT}
          Service Health: ${FAILED_SERVICES} failed
          ---------------------------------------------------------------

          EOF
      when: ansible_facts.os_family == "Debian"

    - name: Ensure /etc/motd is empty
      ansible.builtin.copy:
        dest: /etc/motd
        content: ""
        owner: root
        group: root
        mode: '0644'
      when: ansible_facts.os_family == "Debian"

    ###########################################################################
    # Reboot if required (Debian/Ubuntu)
    ###########################################################################
    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required
      when: ansible_facts.os_family == "Debian"

    - name: Reboot if required
      ansible.builtin.reboot:
      when:
        - ansible_facts.os_family == "Debian"
        - reboot_required.stat.exists

  handlers:
    - name: Restart SSH
      ansible.builtin.service:
        name: "{{ 'ssh' if ansible_facts.os_family == 'Debian' else 'sshd' }}"
        state: restarted


###############################################################################
# PLAY 2 — docker-agent (docker-hosts only)
###############################################################################
- name: Ensure docker-agent exists on docker hosts
  hosts: docker-hosts
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Ensure docker-agent group exists
      ansible.builtin.group:
        name: docker-agent
        gid: 1101
        system: true
        state: present

    - name: Ensure docker-agent user exists
      ansible.builtin.user:
        name: docker-agent
        uid: 1101
        group: docker-agent
        shell: /usr/sbin/nologin
        create_home: no
        system: true
        password: "{{ lookup('env', 'DOCKER_AGENT_PASSWORD') | password_hash('sha512') }}"


###############################################################################
# PLAY 3 — k3s-agent (k3s-hosts only)
###############################################################################
- name: Create k3s-agent user and grant passwordless sudo
  hosts: k3s-hosts
  become: true
  become_method: sudo
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Create k3s-agent user with password
      ansible.builtin.user:
        name: k3s-agent
        groups: sudo
        state: present
        shell: /bin/bash
        password: "{{ lookup('env', 'K3S_AGENT_PASSWORD') | password_hash('sha512') }}"

    - name: Create .ssh directory for k3s-agent
      ansible.builtin.file:
        path: /home/k3s-agent/.ssh
        state: directory
        owner: k3s-agent
        group: k3s-agent
        mode: '0700'

    - name: Add Eddie's SSH key to k3s-agent's authorized_keys
      ansible.posix.authorized_key:
        user: k3s-agent
        state: present
        key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIF+zfnhEIwiI2u03QnRjghuAYFQRbdzqT1pXHWD69eaG"

    - name: Grant k3s-agent passwordless sudo
      ansible.builtin.copy:
        dest: /etc/sudoers.d/k3s-agent
        content: "k3s-agent ALL=(ALL) NOPASSWD: ALL\n"
        owner: root
        group: root
        mode: '0440'
        validate: 'visudo -cf %s'