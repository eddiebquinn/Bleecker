---
- name: Basic health checks
  hosts: all:!core_infra:!provisioning
  become: true
  become_method: sudo
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:

    - name: Create eddie user with password
      ansible.builtin.user:
        name: eddie
        groups: sudo
        state: present
        shell: /bin/bash
        password: "{{ lookup('env', 'EDDIE_PASSWORD') | password_hash('sha512') }}"

    - name: Create .ssh directory for eddie
      ansible.builtin.file:
        path: /home/eddie/.ssh
        state: directory
        owner: eddie
        group: eddie
        mode: '0700'

    - name: Add GPG SSH keys to eddie's authorized_keys
      ansible.posix.authorized_key:
        user: eddie
        state: present
        key: |
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINt1KNkGPH+YPWl6qHX0PhbsevkEw8H1R86nOVV03k8Z
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIF+zfnhEIwiI2u03QnRjghuAYFQRbdzqT1pXHWD69eaG

    - name: Configure SSH to disable root login and only allow public key authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
        backrefs: yes
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
      notify: Restart SSH

    - name: Ensure lsb-release is present
      ansible.builtin.apt:
        name: lsb-release
        state: present
        update_cache: yes
      when: ansible_facts['os_family'] == 'Debian'

    - name: Ensure update-motd directory exists
      ansible.builtin.file:
        path: /etc/update-motd.d
        state: directory
        owner: root
        group: root
        mode: '0755'
      when: ansible_facts['os_family'] == 'Debian'

    - name: Deploy custom dynamic MOTD script
      ansible.builtin.copy:
        dest: /etc/update-motd.d/50-custom
        owner: root
        group: root
        mode: '0755'
        content: |
          #!/bin/bash
          #
          # Custom MOTD with host, distro, last login, updates, and service health
          #
          set -euo pipefail

          HOSTNAME=$(hostname)
          DISTRO=$(lsb_release -ds 2>/dev/null || head -n 1 /etc/*release 2>/dev/null)

          # Last login (excluding current session)
          LAST_LINE=$(last -n 5 -w -R | grep -v -E '^(reboot|shutdown|wtmp begins)' | head -n 1 || true)
          LAST_USER=$(echo "$LAST_LINE" | awk '{print $1}')
          LAST_FROM=$(echo "$LAST_LINE" | awk '{print $3}')

          # APT info (only on apt systems)
          if command -v apt >/dev/null 2>&1; then
              PACKAGE_COUNT=$(dpkg -l 2>/dev/null | wc -l)
              PENDING_UPDATES=$(apt list --upgradable 2>/dev/null | grep -v '^Listing' | wc -l)
          else
              PACKAGE_COUNT="N/A"
              PENDING_UPDATES="N/A"
          fi

          # systemd failed units
          if command -v systemctl >/dev/null 2>&1; then
              FAILED_SERVICES=$(systemctl --failed --no-legend 2>/dev/null | wc -l)
          else
              FAILED_SERVICES="N/A"
          fi

          cat <<EOF

          ---------------------------------------------------------------
          Host: ${HOSTNAME}
          Distro: ${DISTRO}
          Last Login: ${LAST_USER:-N/A} from ${LAST_FROM:-N/A}

          APT Health: ${PENDING_UPDATES} / ${PACKAGE_COUNT}
          Service Health: ${FAILED_SERVICES} failed
          ---------------------------------------------------------------

          EOF
      when: ansible_facts['os_family'] == 'Debian'

    # === Only show the custom MOTD block (Debian) ===

    - name: Disable other update-motd snippets (keep 50-custom)
      ansible.builtin.shell: |
        set -e
        for d in /etc/update-motd.d /usr/lib/update-motd.d; do
          [ -d "$d" ] || continue
          find "$d" -type f ! -name '50-custom' -exec chmod 0644 {} +
        done
      args:
        executable: /bin/bash
      when: ansible_facts['os_family'] == 'Debian'

    - name: Comment out PAM static motd line in /etc/pam.d/sshd
      ansible.builtin.lineinfile:
        path: /etc/pam.d/sshd
        regexp: '^\s*session\s+optional\s+pam_motd\.so\s+motd=/etc/motd'
        line: '# \g<0>'
        backrefs: yes
      when: ansible_facts['os_family'] == 'Debian'

    - name: Ensure /etc/motd is empty (avoid Debian blurb)
      ansible.builtin.copy:
        dest: /etc/motd
        content: ""
        owner: root
        group: root
        mode: '0644'
      when: ansible_facts['os_family'] == 'Debian'

    - name: Disable SSH's own LastLogin line (we print it ourselves)
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^\s*PrintLastLog\s+'
        line: 'PrintLastLog no'
        create: no
      when: ansible_facts['os_family'] == 'Debian'
      notify: Restart SSH

  handlers:
    - name: Restart SSH
      ansible.builtin.service:
        name: "{{ 'ssh' if ansible_facts.os_family == 'Debian' else 'sshd' }}"
        state: restarted

    - name: Reboot if required
      ansible.builtin.reboot:
      when: ansible_facts['pkg_mgr'] == 'apt' and ansible_facts['needs_restarting'] == 'reboot-required'


- name: Ensure docker-agent exists on docker hosts
  hosts: docker-hosts
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Ensure docker-agent group exists
      ansible.builtin.group:
        name: docker-agent
        gid: 1101
        state: present
        system: true
      when: "'docker-hosts' in group_names"

    - name: Ensure docker-agent user exists
      ansible.builtin.user:
        name: docker-agent
        uid: 1101
        group: docker-agent
        shell: /usr/sbin/nologin
        create_home: no
        system: true
        password: "{{ lookup('env', 'DOCKER_AGENT_PASSWORD') | password_hash('sha512') }}"
      when: "'docker-hosts' in group_names"
