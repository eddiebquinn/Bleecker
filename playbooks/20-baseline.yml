---
- name: Baseline hardening + packages + MOTD + service prep
  hosts: managed
  become: true
  gather_facts: true

  tasks:
    ###########################################################################
    # Baseline packages (Debian)
    ###########################################################################
    - name: Install baseline packages (Debian)
      ansible.builtin.apt:
        name: "{{ baseline_apt_packages }}"
        state: present
        update_cache: true
      when: ansible_facts.os_family == "Debian"

    ###########################################################################
    # eddie user + keys
    ###########################################################################
    - name: Ensure eddie user exists
      ansible.builtin.user:
        name: eddie
        groups: sudo
        append: true
        shell: /bin/bash
        state: present

    - name: Ensure .ssh directory for eddie
      ansible.builtin.file:
        path: /home/eddie/.ssh
        state: directory
        owner: eddie
        group: eddie
        mode: '0700'

    - name: Ensure eddie authorized keys are present
      ansible.posix.authorized_key:
        user: eddie
        state: present
        key: "{{ item }}"
      loop: "{{ eddie_authorized_keys }}"

    ###########################################################################
    # SSH Hardening
    ###########################################################################
    - name: Disable root login and password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
        backrefs: true
        validate: "sshd -t -f %s"
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^\s*PrintLastLog\s+', line: 'PrintLastLog no' }
      notify: Restart SSH

    ###########################################################################
    # Debian apt-daily timer suppression
    ###########################################################################
    - name: Stop apt-daily timers (Debian)
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: false
        state: stopped
        daemon_reload: true
      loop:
        - apt-daily.timer
        - apt-daily-upgrade.timer
      when: ansible_facts.os_family == "Debian"

    - name: Mask apt-daily services (Debian)
      ansible.builtin.systemd:
        name: "{{ item }}"
        masked: true
        enabled: false
        state: stopped
      loop:
        - apt-daily.service
        - apt-daily-upgrade.service
      when: ansible_facts.os_family == "Debian"

    ###########################################################################
    # Custom MOTD (Debian)
    ###########################################################################
    - name: Ensure update-motd directory exists (Debian)
      ansible.builtin.file:
        path: /etc/update-motd.d
        state: directory
        owner: root
        group: root
        mode: '0755'
      when: ansible_facts.os_family == "Debian"

    - name: Deploy custom dynamic MOTD (Debian)
      ansible.builtin.copy:
        dest: /etc/update-motd.d/50-custom
        owner: root
        group: root
        mode: '0755'
        content: |
          #!/bin/bash
          set -euo pipefail

          HOSTNAME=$(hostname)
          DISTRO=$(lsb_release -ds 2>/dev/null || head -n 1 /etc/*release 2>/dev/null)

          LAST_LINE=$(last -n 5 -w -R | grep -v -E '^(reboot|shutdown|wtmp begins)' | head -n 1 || true)
          LAST_USER=$(echo "$LAST_LINE" | awk '{print $1}')
          LAST_FROM=$(echo "$LAST_LINE" | awk '{print $3}')

          if command -v apt >/dev/null 2>&1; then
              PACKAGE_COUNT=$(dpkg -l 2>/dev/null | wc -l)
              PENDING_UPDATES=$(apt list --upgradable 2>/dev/null | grep -v '^Listing' | wc -l)
          else
              PACKAGE_COUNT="N/A"
              PENDING_UPDATES="N/A"
          fi

          if command -v systemctl >/dev/null 2>&1; then
              FAILED_SERVICES=$(systemctl --failed --no-legend 2>/dev/null | wc -l)
          else
              FAILED_SERVICES="N/A"
          fi

          cat <<EOF

          ---------------------------------------------------------------
          Host: ${HOSTNAME}
          Distro: ${DISTRO}
          Last Login: ${LAST_USER:-N/A} from ${LAST_FROM:-N/A}

          APT Health: ${PENDING_UPDATES} / ${PACKAGE_COUNT}
          Service Health: ${FAILED_SERVICES} failed
          ---------------------------------------------------------------

          EOF
      when: ansible_facts.os_family == "Debian"

    - name: Ensure /etc/motd is empty (Debian)
      ansible.builtin.copy:
        dest: /etc/motd
        content: ""
        owner: root
        group: root
        mode: '0644'
      when: ansible_facts.os_family == "Debian"

    ###########################################################################
    # Docker prep (docker-hosts)
    ###########################################################################
    - name: Ensure docker-agent group exists
      ansible.builtin.group:
        name: docker-agent
        gid: 1101
        system: true
        state: present
      when: "'docker_hosts' in group_names"

    - name: Ensure docker-agent user exists
      ansible.builtin.user:
        name: docker-agent
        uid: 1101
        group: docker-agent
        shell: /usr/sbin/nologin
        create_home: false
        system: true
        password: "{{ lookup('env', 'DOCKER_AGENT_PASSWORD') | password_hash('sha512') }}"
      when: "'docker-hosts' in group_names"
      no_log: true

    - name: Add docker-agent user to Docker group
      ansible.builtin.user:
        name: docker-agent
        groups: docker
        append: true
      when: "'docker-hosts' in group_names"

    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true
      when: "'docker-hosts' in group_names"

    - name: Ensure docker-agent ssh directory exists
      ansible.builtin.file:
        path: "/var/lib/docker-agent/.ssh"
        state: directory
        owner: docker-agent
        group: docker-agent
        mode: "0700"
      when: "'docker-hosts' in group_names"

    - name: Install docker-agent private key
      ansible.builtin.copy:
        content: "{{ lookup('env', 'DOCKER_AGENT_PRIVATE_KEY') }}"
        dest: "/var/lib/docker-agent/.ssh/id_rsa"
        owner: docker-agent
        group: docker-agent
        mode: "0600"
      when: "'docker-hosts' in group_names"
      no_log: true

    - name: Ensure docker-agent known_hosts contains gitlab-ssh host key
      ansible.builtin.known_hosts:
        path: "/var/lib/docker-agent/.ssh/known_hosts"
        name: "gitlab-ssh.eddiequinn.casa"
        key: "{{ lookup('pipe', 'ssh-keyscan -t rsa gitlab-ssh.eddiequinn.casa 2>/dev/null') }}"
        state: present
      when: "'docker-hosts' in group_names"

    ###########################################################################
    # k3s agent user (k3s-hosts)
    ###########################################################################
    - name: Ensure k3s-agent user exists
      ansible.builtin.user:
        name: k3s-agent
        groups: sudo
        state: present
        shell: /bin/bash
        password: "{{ lookup('env', 'K3S_AGENT_PASSWORD') | password_hash('sha512') }}"
      when: "'k3s_hosts' in group_names"
      no_log: true

    - name: Ensure .ssh directory for k3s-agent
      ansible.builtin.file:
        path: /home/k3s-agent/.ssh
        state: directory
        owner: k3s-agent
        group: k3s-agent
        mode: '0700'
      when: "'k3s-hosts' in group_names"

    - name: Add Eddie's SSH key to k3s-agent's authorized_keys
      ansible.posix.authorized_key:
        user: k3s-agent
        state: present
        key: "{{ eddie_authorized_keys[1] }}"
      when: "'k3s-hosts' in group_names"

    - name: Grant k3s-agent passwordless sudo
      ansible.builtin.copy:
        dest: /etc/sudoers.d/k3s-agent
        content: "k3s-agent ALL=(ALL) NOPASSWD: ALL\n"
        owner: root
        group: root
        mode: '0440'
        validate: 'visudo -cf %s'
      when: "'k3s-hosts' in group_names"

  handlers:
    - name: Restart SSH
      ansible.builtin.service:
        name: "{{ 'ssh' if ansible_facts.os_family == 'Debian' else 'sshd' }}"
        state: restarted
